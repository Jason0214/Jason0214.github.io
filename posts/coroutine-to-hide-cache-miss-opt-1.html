<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Coroutine to Hide Cache Miss Optimization (1)</title>
    <meta name="generator" content="VuePress 1.5.0">
    
    <meta name="description" content="">
    <link rel="preload" href="/assets/css/0.styles.a7a650b7.css" as="style"><link rel="preload" href="/assets/js/app.c34e6706.js" as="script"><link rel="preload" href="/assets/js/6.5200d407.js" as="script"><link rel="preload" href="/assets/js/1.ed51565e.js" as="script"><link rel="preload" href="/assets/js/2.7fd9a54f.js" as="script"><link rel="preload" href="/assets/js/18.9d1c7c54.js" as="script"><link rel="prefetch" href="/assets/js/10.7c5e8cee.js"><link rel="prefetch" href="/assets/js/11.78270a0e.js"><link rel="prefetch" href="/assets/js/12.51b33934.js"><link rel="prefetch" href="/assets/js/13.9aa85bfc.js"><link rel="prefetch" href="/assets/js/14.6e5d83c4.js"><link rel="prefetch" href="/assets/js/15.7b475cef.js"><link rel="prefetch" href="/assets/js/16.2fba18a8.js"><link rel="prefetch" href="/assets/js/17.7ef9a15e.js"><link rel="prefetch" href="/assets/js/19.46bb81dc.js"><link rel="prefetch" href="/assets/js/20.aa392f3a.js"><link rel="prefetch" href="/assets/js/21.c76916a2.js"><link rel="prefetch" href="/assets/js/22.c2774776.js"><link rel="prefetch" href="/assets/js/23.3ec356ed.js"><link rel="prefetch" href="/assets/js/24.e7b06244.js"><link rel="prefetch" href="/assets/js/25.d03911da.js"><link rel="prefetch" href="/assets/js/26.27e67049.js"><link rel="prefetch" href="/assets/js/5.bbd5390b.js"><link rel="prefetch" href="/assets/js/7.470e962e.js"><link rel="prefetch" href="/assets/js/8.46271304.js"><link rel="prefetch" href="/assets/js/9.dc4a5b3d.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.dd1bc204.js">
    <link rel="stylesheet" href="/assets/css/0.styles.a7a650b7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/#posts" class="nav-link">
  Posts
</a></div><div class="nav-item"><a href="/#readings" class="nav-link">
  Readings
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Misc" class="dropdown-title"><span class="title">Misc</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/channel-links.html" class="nav-link">
  Playlists
</a></li><li class="dropdown-item"><!----> <a href="/photos/photos.html" class="nav-link">
  Photography
</a></li></ul></div></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/#posts" class="nav-link">
  Posts
</a></div><div class="nav-item"><a href="/#readings" class="nav-link">
  Readings
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Misc" class="dropdown-title"><span class="title">Misc</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/channel-links.html" class="nav-link">
  Playlists
</a></li><li class="dropdown-item"><!----> <a href="/photos/photos.html" class="nav-link">
  Photography
</a></li></ul></div></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-astrid-content"><h1 id="coroutine-to-hide-cache-miss-optimization-(1)"><a href="#coroutine-to-hide-cache-miss-optimization-(1)" class="header-anchor">#</a>
      Coroutine to Hide Cache Miss Optimization (1)
    </h1> <div class="content__default"><p>Last year I co-authored the <a href="http://www.vldb.org/pvldb/vol14/p431-he.pdf" target="_blank" rel="noopener noreferrer">Corobase<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> paper
which was published on PVLDB 2021.
The paper describes the approach to hide data stalls in an in-memory database with <a href="https://en.cppreference.com/w/cpp/language/coroutines" target="_blank" rel="noopener noreferrer">stackless coroutine<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.
Still, there left several open questions, for example, how to properly inline a coroutine,
which this post may help you to understand.</p> <h2 id="stackless-coroutine"><a href="#stackless-coroutine" class="header-anchor">#</a> Stackless coroutine</h2> <p>First, what is coroutine? Coroutine was born in the early days of computers, as a sibling of Function.
Function is one-shot subroutine,
while Coroutine can be suspended in the middle to return to the caller and then get resumed some time later.
Stackless coroutine is opposed to stackful coroutine.
They are different implementations of coroutine.</p> <p>Most of the libraries implement coroutine and fiber (coroutine on thread executors) with stackful coroutine, for example Boost::Coroutine.
Stackful coroutine allocates another stack dedicated to a coroutine context.
The side stack is identical to the process stack,
which uses frame pointer, stack pointer, etc. to manage coroutine call stack.
Stackful coroutine can be easily suspended because all the coroutine's states resides in the coroutine stack
and never interfere with the process stack.</p> <p>Stackless coroutine implementation has no side stacks.
Stack frame of a coroutine call lies on the process stack.
This design makes coroutine cheaper to call, suspend and resume than its stackful peer,
where the latter has a larger memory footprint and requires dynamic allocations when stack grows.
However, running coroutine on the process stack makes suspending and resuming not straightforward.
Each time the coroutine get resumed, a new stack frame is pushed to the stack.
But there are runtime states, such as value of local variables that lives across suspendings.
Obviously, the states can not be saved not on the stack,
otherwise they quickly gets overwritten by function calls following coroutine suspending.</p> <p>The clang(LLVM)'s implementation of stackless coroutine dynamic allocates the memory called coroutine frame
for keeping the states.
Local variables are saved to the coroutine frame on suspending and reloaded back to the process stack on resuming.
Other states like return value and whether suspendable go to the coroutine frame as well.</p> <h2 id="coroutine-to-hide-data-stall"><a href="#coroutine-to-hide-data-stall" class="header-anchor">#</a> Coroutine to hide data stall</h2> <p>The clang's implementation of stackless coroutine has very cheap context switches
(not the same &quot;context-switch&quot; in multi-threading,
here it means suspending from a coroutine and resuming another one).
I am not able to find the exact timing of a context switch,
but it is definitely cheaper than a last level cache-miss
on modern server CPUs (which actually have lower frequency than desktop ones) and latest DRAMs.</p> <p>The fact leads to the idea about hiding memory stalls with coroutine-alike executions.
Basically, on data loading where cache miss is very likely to happen,
issue a memory prefetch following a coroutine suspend (Note, suspending is unconditionally.
There is no way for any arch to tell by definite whether the data is going to miss).
So that data is getting loaded from memory to cache, in the meantime that data won't be used by CPU at the moment,
and no data stalls.
When the next time, this suspended coroutine gets resumed, hopefully the loading data is already in cache.</p> <p>As far as I know, the technique started from
<a href="https://dl.acm.org/doi/10.14778/2856318.2856321#:~:text=This%20work%20introduces%20Asynchronous%20Memory,from%20that%20of%20other%20lookups." target="_blank" rel="noopener noreferrer">Asynchronous Memory Access Chaining<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
which manages a state-machine-alike AMAC by hand to do suspending and resuming,
then followed by
<a href="http://www.vldb.org/pvldb/vol11/p230-psaropoulos.pdf" target="_blank" rel="noopener noreferrer">Interleaving with Coroutines: A Practical Approach for Robust Index Joins<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
to replace AMAC with stackless coroutine and confirmed its effectiveness on Binary Search,
and then
<a href="http://www.vldb.org/pvldb/vol11/p1702-jonathan.pdf" target="_blank" rel="noopener noreferrer">Exploiting Coroutines to Attack the “Killer Nanoseconds”<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
evaluates stackless coroutine on Masstree and BwTree.</p> <p><a href="http://www.vldb.org/pvldb/vol14/p431-he.pdf" target="_blank" rel="noopener noreferrer">Corobase<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is a follow up work to employ the technique to the whole database.</p> <h2 id="target-at-usability"><a href="#target-at-usability" class="header-anchor">#</a> Target at usability</h2> <p><a href="http://www.vldb.org/pvldb/vol11/p1702-jonathan.pdf" target="_blank" rel="noopener noreferrer">Exploiting Coroutines to Attack the “Killer Nanoseconds”<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
is a great paper about hiding data stalls on complex indexing data structures such as Masstree,
but unfortunately it is not open sourced to use.</p> <p><a href="http://www.vldb.org/pvldb/vol14/p431-he.pdf" target="_blank" rel="noopener noreferrer">Corobase<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> has no ambition to surpass the performance of
<a href="http://www.vldb.org/pvldb/vol11/p1702-jonathan.pdf" target="_blank" rel="noopener noreferrer">Exploiting Coroutines to Attack the “Killer Nanoseconds”<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.
Because in whole databases, coroutine not only needs to operate on the indexing Masstree
(for people not familiar, it is a combination of B+Tree and Trie),
but also the value storage, in our case, MVCC
(Multi-version concurrency control, each value is a linked list of different snapshots in different timestamps).
Complex data structures lead to un-uniform (and larger) memory footprints and less regular cache misses.
That's the reality.</p> <p><a href="http://www.vldb.org/pvldb/vol14/p431-he.pdf" target="_blank" rel="noopener noreferrer">Corobase<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> does not want to be a proof of concept,
others already proved it well.
It wants to be really useful for industry, where a traditional database can make very limited modifications to use the coroutine.</p> <p>In the <a href="https://github.com/sfu-dis/Corobase/blob/81ddcf54a553e6feb6a706580d91574ec53870ab/dbcore/sm-coroutine.h#L517" target="_blank" rel="noopener noreferrer">coroutine implementation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, a normal function can be convert to a coroutine by:</p> <ol><li>Replace return type <code>T</code> with <code>Promise(T)</code> in function definition.</li> <li>Insert <code>std::suspend_always</code> and <code>prefetch</code> on a data load that is highly likely to cause cache miss.</li></ol> <p>We happily rollout this change to our previous non-coroutine database,
However, we found it does not scale well with the level of function calls.
Note, a nested stackless coroutine requires manual management of its call chain,
so that each uncompleted coroutine in the chain gets resumed in the correct order.
Corobase used a double linked list to do it, after comparing performance of stack, circular-array, etc.
We didn't manage to solve the scale problem in the end and falls back to a two-level approach,
which basically needs to &quot;inline&quot; a chain of function calls into a big function by hand.
Read the paper for the details if you are interested.</p> <h2 id="inline-coroutine-in-llvm-possible"><a href="#inline-coroutine-in-llvm-possible" class="header-anchor">#</a> Inline Coroutine in LLVM, Possible?</h2> <p>The two-level approach works great on real world workloads with a reasonable amount of throughput improvement.
But it is not so good from the user perspective.
Inlining by hand to two-level, though very easy to do, should definitely be done by the compiler.</p> <p>Automating inlining coroutine is not trivial.
For functions you can put <code>inline</code> attributes to hint the compiler,
there is no way to do the same thing for a coroutine.
Coroutine is not a function from the perspective of LLVM.
In the LLVM optimization passes,
coroutine get splitted to three functions in the name of <code>xxx.init()</code>, <code>xxx.resume()</code> and <code>xxx.destroy()</code>
right before CGSCC (call graph strongly connected components) pass.
In CGSCC, each splitted function may be inlined if they get devirtualized.
Refer to <a href="https://lists.llvm.org/pipermail/llvm-dev/2016-July/102337.html" target="_blank" rel="noopener noreferrer">https://lists.llvm.org/pipermail/llvm-dev/2016-July/102337.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> for the optimization passes design for coroutine.</p> <p>Why &quot;devirtualized&quot;? Because C++ coroutine is manipulated through <code>coroutine_handle&lt;promise_type_T&gt;</code>
or a generic handle <code>coroutine_handle&lt;void&gt;</code>.
Resume a coroutine by calling <code>coroutine_handle&lt;void&gt;.resume()</code> is an indirect function call.
Virtual function call can not be inlined.
Unfortunately Corobase resumes every coroutine indirectly:</p> <ol><li>direct call <a href="https://github.com/sfu-dis/Corobase/blob/81ddcf54a553e6feb6a706580d91574ec53870ab/masstree/masstree_get.hh#L64" target="_blank" rel="noopener noreferrer"><code>co_await &lt;expr&gt;</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> only reaches <a href="https://github.com/sfu-dis/Corobase/blob/81ddcf54a553e6feb6a706580d91574ec53870ab/dbcore/sm-coroutine.h#L107" target="_blank" rel="noopener noreferrer"><code>initial_suspend</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> without doing any work.</li> <li>in <a href="https://github.com/sfu-dis/Corobase/blob/81ddcf54a553e6feb6a706580d91574ec53870ab/benchmarks/ycsb-cs-advance.cc#L76" target="_blank" rel="noopener noreferrer">scheduler<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>, where schedule the next coroutine resumption, every call is indirect.</li></ol> <p>Will explain later why <code>initial_suspend</code> is necessary and what happens if remove.</p> <h2 id="how-to-improve"><a href="#how-to-improve" class="header-anchor">#</a> How to improve?</h2> <p>The scheduler part is identical in both nested and two-level.
So if we can make every <code>co_await &lt;expr&gt;</code> inlined,
then hopefully nested coroutine calls would have performance close to two-level ones.</p> <p>The above fact is not that intuitive, more explaining:
A chain of coroutines, whether two-level and nested,
are all executed from <code>coroutine_handle&lt;void&gt;.resume()</code> in <code>scheduler</code>.
The number of <code>coroutine_handle&lt;void&gt;.resume()</code> gets called is same for two-level and nested,
which depends on the added suspending points.
Two-level only eliminites the <code>co_await &lt;expr&gt;</code> calls inside each <code>coroutine_handle&lt;void&gt;.resume()</code>
(and two-level made the assumption that the linked list can only has two nodes, but I think that is neglectable).</p> <p>The following text describes some of my ideas and practices to try to inline the <code>co_await &lt;expr&gt;</code>.</p> <h4 id="_1-immediately-resume-after-initial-suspend"><a href="#_1-immediately-resume-after-initial-suspend" class="header-anchor">#</a> 1) Immediately resume after initial_suspend</h4> <p><code>co_await &lt;expr&gt;;</code> internally is <code>awaitable_T awaitable_instance = &lt;expr&gt;; co_await awaitable_instance;</code> <code>initial_suspend</code> happens in <code>awaitable_instance</code>'s construction and
<code>co_await</code> translates to a <code>await_suspend()</code> call on <code>awaitable_T::awaiter</code>.</p> <p>In Corobase, <code>await_suspend()</code> does nothing but establish the caller and callee relation,
all the resuming are handled in the scheduler by indirect calls.</p> <p>I tried to move the first <code>resume()</code> textually close to the <code>awaitable_instance</code>'s construction,
hoping the compiler is able to devirtualize the resuming call by referring to its local context.</p> <p>The following lines of code get added in <code>awaitable_T::awaiter</code>.
Because of the <code>initial_suspend</code>, this resuming should always be a valid call.</p> <div class="language-Diff extra-class"><pre class="language-diff"><code>// suspended_task_coroutine points to coroutine being co_awaited on
//
// awaiting_coroutine points to the coroutine running co_await
// (i.e. it waits for suspended_task_coroutine to complete first)
template &lt;typename T&gt; struct task&lt;T&gt;::awaiter {
...
<span class="token unchanged">  template &lt;typename awaiting_promise_t&gt;
  auto await_suspend(std::experimental::coroutine_handle&lt;awaiting_promise_t&gt; awaiting_coroutine) noexcept {
    suspended_task_coroutine_.promise().set_parent(&amp;(awaiting_coroutine.promise()));
</span><span class="token inserted-sign inserted">+   suspended_task_coroutine_.resume();
+   // Force coroutine with no suspending points invalid.
+   ASSERT(!suspended_task_coroutine_.done());
</span><span class="token deleted-sign deleted">-    return suspended_task_coroutine_;
</span><span class="token inserted-sign inserted">+    return void;
</span><span class="token unchanged">  }
  
  constexpr bool await_ready() const noexcept {
      return false;
  }
</span>...
};
</code></pre></div><p>I compiled a simplified version of the <a href="https://github.com/sfu-dis/Corobase/blob/81ddcf54a553e6feb6a706580d91574ec53870ab/tests/coroutine/resume_order.cpp" target="_blank" rel="noopener noreferrer">sample<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>
and checked the generated LLVM IR in <code>-O3</code>:</p> <div class="language-LLVM extra-class"><pre class="language-llvm"><code><span class="token comment">; demangle to task&lt;void&gt; ChainedCoroCall&lt;5&gt;(int*).resume</span>
<span class="token keyword">define</span> <span class="token keyword">internal</span> <span class="token keyword">fastcc</span> <span class="token type class-name">void</span> <span class="token variable">@_Z15ChainedCoroCallILi5EE4taskIvEPi.resume</span><span class="token punctuation">(</span><span class="token variable">%_Z15ChainedCoroCallILi5EE4taskIvEPi.Frame</span><span class="token punctuation">*</span> <span class="token keyword">noalias</span> <span class="token keyword">nonnull</span> <span class="token keyword">align</span> <span class="token number">8</span> <span class="token keyword">dereferenceable</span><span class="token punctuation">(</span><span class="token number">432</span><span class="token punctuation">)</span> <span class="token variable">%FramePtr</span><span class="token punctuation">)</span> <span class="token variable">#0</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token comment">; demangle to promise_base::set_parent(promise_base*)</span>
<span class="token label">_ZN12promise_base10set_parentEPS_.exit.i:</span>         <span class="token comment">; preds = %init.ready</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">; demangle to task&lt;void&gt; ChainedCoroCall&lt;4&gt;(int*).resume</span>
    <span class="token keyword">call</span> <span class="token keyword">fastcc</span> <span class="token type class-name">void</span> <span class="token variable">@_Z15ChainedCoroCallILi4EE4taskIvEPi.resume</span><span class="token punctuation">(</span><span class="token variable">%_Z15ChainedCoroCallILi4EE4taskIvEPi.Frame</span><span class="token punctuation">*</span> <span class="token keyword">nonnull</span> <span class="token variable">%.reload.addr119</span><span class="token punctuation">)</span> <span class="token variable">#2</span>
    <span class="token comment">; demangle to task&lt;void&gt; ChainedCoroCall&lt;4&gt;(int*).Frame</span>
    <span class="token comment">; direct call :)</span>
    <span class="token variable">%18</span> <span class="token punctuation">=</span> <span class="token keyword">bitcast</span> <span class="token variable">%_Z15ChainedCoroCallILi4EE4taskIvEPi.Frame</span><span class="token punctuation">*</span> <span class="token variable">%.reload.addr119</span> <span class="token keyword">to</span> <span class="token type class-name">i8</span><span class="token punctuation">*</span><span class="token punctuation">*</span>
    <span class="token variable">%19</span> <span class="token punctuation">=</span> <span class="token keyword">load</span> <span class="token type class-name">i8</span><span class="token punctuation">*</span><span class="token punctuation">,</span> <span class="token type class-name">i8</span><span class="token punctuation">*</span><span class="token punctuation">*</span> <span class="token variable">%18</span><span class="token punctuation">,</span> <span class="token keyword">align</span> <span class="token number">8</span>
    <span class="token variable">%20</span> <span class="token punctuation">=</span> <span class="token keyword">icmp</span> <span class="token keyword">eq</span> <span class="token type class-name">i8</span><span class="token punctuation">*</span> <span class="token variable">%19</span><span class="token punctuation">,</span> <span class="token keyword">null</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
  
</code></pre></div><p>Compare to the resuming call in scheduler:</p> <div class="language-LLVM extra-class"><pre class="language-llvm"><code><span class="token comment">; demangle to promise_base::get_leaf() const</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token label">_ZNK12promise_base8get_leafEv.exit:</span>               <span class="token comment">; preds = %_ZNK12promise_base8get_leafEv.exit64</span>
  <span class="token variable">%8</span> <span class="token punctuation">=</span> <span class="token keyword">bitcast</span> <span class="token type class-name">i8</span><span class="token punctuation">*</span> <span class="token variable">%retval.sroa.0.0.copyload.i71</span> <span class="token keyword">to</span> <span class="token punctuation">{</span> <span class="token type class-name">i8</span><span class="token punctuation">*</span><span class="token punctuation">,</span> <span class="token type class-name">i8</span><span class="token punctuation">*</span> <span class="token punctuation">}</span><span class="token punctuation">*</span>
  <span class="token variable">%9</span> <span class="token punctuation">=</span> <span class="token keyword">getelementptr</span> <span class="token keyword">inbounds</span> <span class="token punctuation">{</span> <span class="token type class-name">i8</span><span class="token punctuation">*</span><span class="token punctuation">,</span> <span class="token type class-name">i8</span><span class="token punctuation">*</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token type class-name">i8</span><span class="token punctuation">*</span><span class="token punctuation">,</span> <span class="token type class-name">i8</span><span class="token punctuation">*</span> <span class="token punctuation">}</span><span class="token punctuation">*</span> <span class="token variable">%8</span><span class="token punctuation">,</span> <span class="token type class-name">i32</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token type class-name">i32</span> <span class="token number">0</span>
  <span class="token variable">%10</span> <span class="token punctuation">=</span> <span class="token keyword">load</span> <span class="token type class-name">i8</span><span class="token punctuation">*</span><span class="token punctuation">,</span> <span class="token type class-name">i8</span><span class="token punctuation">*</span><span class="token punctuation">*</span> <span class="token variable">%9</span><span class="token punctuation">,</span> <span class="token keyword">align</span> <span class="token number">8</span>
  <span class="token variable">%11</span> <span class="token punctuation">=</span> <span class="token keyword">bitcast</span> <span class="token type class-name">i8</span><span class="token punctuation">*</span> <span class="token variable">%10</span> <span class="token keyword">to</span> <span class="token type class-name">void</span> <span class="token punctuation">(</span><span class="token type class-name">i8</span><span class="token punctuation">*</span><span class="token punctuation">)</span><span class="token punctuation">*</span>
  <span class="token comment">; indirect call :(</span>
  <span class="token keyword">tail</span> <span class="token keyword">call</span> <span class="token keyword">fastcc</span> <span class="token type class-name">void</span> <span class="token variable">%11</span><span class="token punctuation">(</span><span class="token type class-name">i8</span><span class="token punctuation">*</span> <span class="token keyword">nonnull</span> <span class="token variable">%retval.sroa.0.0.copyload.i71</span><span class="token punctuation">)</span> <span class="token variable">#2</span>
  <span class="token keyword">ret</span> <span class="token type class-name">void</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
</code></pre></div><p><s>We are getting direct call to <code>ChainedCoroCall&lt;4&gt;(int*).resume</code>!</s></p> <p>(Edit: When <code>return suspended_task_coroutine_</code>, the suspended task will be resumed immediately. So there is no new direct call here compared to Corobase)</p> <p>If we can somehow get some attributes passed into the optimization pass or even tweak the optimizer,
we can definitely inline this.
I will leave the actual inling and performance comparison for the next post.</p> <h4 id="_2-remove-initial-suspend"><a href="#_2-remove-initial-suspend" class="header-anchor">#</a> 2) Remove <code>initial_suspend</code></h4> <p><code>initial_suspend</code> exists in the double linked list tracking of coroutine frames to
let the leaf coroutine frame set itself to the root coroutine frame so that
when resuming leaf coroutine can be jumped to with O(1) cost.</p> <p>Without <code>initial_suspend</code>, the callee can spawn another coroutine frame before establish the
&quot;parent&quot; relation with its caller through <code>co_await</code>.
That may cause the chain of coroutine frame breaking in the middle when the leaf coroutine frame suspends.</p> <p>To compensate, either</p> <ol><li>do a full linked list traversal in resuming a chain of coroutine to find the leaf,
which takes O(Num_Of_Level) and obviously does not scale. (Inlining reduces Num_Of_Level to 1? so O(1)?</li> <li>or traverse part of the linked list in <code>co_await</code> to update the leaf,
which I don't see the amortized cost but can not be ignored.</li> <li>Get rid of the linked list entirely.
Use a <code>static thread_local</code> FIFO to maintain the coroutine frames' dependencies instead.
We have tested this approach before Corobase and it does not perform well.</li></ol> <p>Still, I removed <code>initial_suspend</code> and made changes to the linked list accordingly,
the generated IR in <code>-O3</code> for the same sample:</p> <div class="language-LLVM extra-class"><pre class="language-llvm"><code><span class="token comment">; demangled to task&lt;void&gt; ChainedCoroCall&lt;5&gt;(int*)</span>
<span class="token keyword">define</span> <span class="token keyword">linkonce_odr</span> <span class="token type class-name">void</span> <span class="token variable">@_Z15ChainedCoroCallILi5EE4taskIvEPi</span><span class="token punctuation">(</span><span class="token variable">%class.task</span><span class="token punctuation">*</span> <span class="token keyword">noalias</span> <span class="token keyword">sret</span> <span class="token keyword">align</span> <span class="token number">8</span> <span class="token variable">%agg.result</span><span class="token punctuation">,</span> <span class="token type class-name">i32</span><span class="token punctuation">*</span> <span class="token variable">%callLevelCounter</span><span class="token punctuation">)</span> <span class="token variable">#0</span> <span class="token punctuation">{</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">call</span> <span class="token type class-name">void</span> <span class="token variable">@llvm.lifetime.start.p0i8</span><span class="token punctuation">(</span><span class="token type class-name">i64</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token type class-name">i8</span><span class="token punctuation">*</span> <span class="token keyword">nonnull</span> <span class="token variable">%ref.tmp11</span><span class="token punctuation">)</span> <span class="token variable">#2</span>
    <span class="token comment">; demangled to task&lt;void&gt; ChainedCoroCall&lt;4&gt;(int*)</span>
    <span class="token comment">; direct call :)</span>
    <span class="token keyword">call</span> <span class="token type class-name">void</span> <span class="token variable">@_Z15ChainedCoroCallILi4EE4taskIvEPi</span><span class="token punctuation">(</span><span class="token variable">%class.task</span><span class="token punctuation">*</span> <span class="token keyword">nonnull</span> <span class="token keyword">sret</span> <span class="token keyword">align</span> <span class="token number">8</span> <span class="token variable">%1</span><span class="token punctuation">,</span> <span class="token type class-name">i32</span><span class="token punctuation">*</span> <span class="token keyword">nonnull</span> <span class="token variable">%callLevelCounter</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">ret</span> <span class="token type class-name">void</span>
</code></pre></div><p>Note <code>ChainedCoroCall&lt;&gt;.resume()</code> in the previous trial becomes <code>ChainedCoroCall&lt;&gt;()</code>.
Because removing <code>initial_suspend</code> causing the actual logic goes to different places in splitting.
But anyway, we get a not inlined direct call again！</p> <p>Same as above, the performance evaluation will go to another post.</p> <h4 id="_3-write-custom-pass-to-inline-coroutine-before-splitting"><a href="#_3-write-custom-pass-to-inline-coroutine-before-splitting" class="header-anchor">#</a> 3) Write custom pass to inline coroutine before splitting</h4> <p>Changing the implementation for awaitable is not the only possible way to inline.
LLVM's optimization pass manager has open interfaces allowing it to create custom passes.</p> <p>Because of the default coroutine optimization pass does splitting,
a good shot to do inlining in a custom pass is to inline before splitting
which basically automates the &quot;inline by hand&quot; in Corobase.</p> <p>But it leads to the problem that the custom pass would be doing inling in places (outside CGSCC)
that should not do intra function optimization.
You never know what would happen if doing so, therefore I consider this to be &quot;the wrong way&quot;.</p> <h4 id="_4-replace-coroutine-optimization-pass-entirely"><a href="#_4-replace-coroutine-optimization-pass-entirely" class="header-anchor">#</a> 4) Replace coroutine optimization pass entirely</h4> <p>Does coroutine really need splitting? I guess not necessarily.
Without splitting, coroutine is just a function with some builtin templates that handles
a dynamic memory region and a virtual interface.</p> <p>I haven't figured out the reason behind the splitting optimization.
But it might be something serving the common usage for stackless coroutine
(Corobase is minority),
such as a multi-threaded event loop to hide IO latency.</p> <p>A fully rewrite of coroutine optimization passes would cost a lot effort
and very likely never possible to be merged into upstream.
I would not take this path when others are workable.</p> <h4 id="_5-rust-s-design"><a href="#_5-rust-s-design" class="header-anchor">#</a> 5) Rust's design</h4> <p>I was told by a friend who did a lot work in Rust
that Rust async, which also uses LLVM stackless coroutine as backend,
exposes a global state machine.</p> <p>Users get fast context switches without thinking &quot;the chain of coroutine frames&quot;.
Same, will look into the design of Rust coroutine in the next post.</p> <h1 id="reference"><a href="#reference" class="header-anchor">#</a> Reference</h1> <ul><li><a href="https://llvm.org/devmtg/2016-11/Slides/Nishanov-LLVMCoroutines.pdf" target="_blank" rel="noopener noreferrer">https://llvm.org/devmtg/2016-11/Slides/Nishanov-LLVMCoroutines.pdf<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://reviews.llvm.org/D23234" target="_blank" rel="noopener noreferrer">https://reviews.llvm.org/D23234<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://lists.llvm.org/pipermail/llvm-dev/2016-July/102337.html" target="_blank" rel="noopener noreferrer">https://lists.llvm.org/pipermail/llvm-dev/2016-July/102337.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://youtu.be/8C8NnE1Dg4A?t=841" target="_blank" rel="noopener noreferrer">https://youtu.be/8C8NnE1Dg4A?t=841<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://llvm.org/docs/Coroutines.html" target="_blank" rel="noopener noreferrer">https://llvm.org/docs/Coroutines.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="http://www.cs.cornell.edu/~asampson/blog/clangpass.html" target="_blank" rel="noopener noreferrer">http://www.cs.cornell.edu/~asampson/blog/clangpass.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated by lujc:</span> <span class="time">2/27/2021, 2:05:28 PM</span></div></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.c34e6706.js" defer></script><script src="/assets/js/6.5200d407.js" defer></script><script src="/assets/js/1.ed51565e.js" defer></script><script src="/assets/js/2.7fd9a54f.js" defer></script><script src="/assets/js/18.9d1c7c54.js" defer></script>
  </body>
</html>

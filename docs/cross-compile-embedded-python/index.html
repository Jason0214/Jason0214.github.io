<!doctype html><html lang=en><head><meta charset=utf-8><meta content=no-referrer name=referrer><meta content="width=device-width,initial-scale=1.0,maximum-scale=5" name=viewport><title>Cross Compile Embedded Python | Jiacheng's Mini Blog</title><meta content="Cross Compile Embedded Python | Jiacheng's Mini Blog" property=og:title><meta content="Cross Compile Embedded Python | Jiacheng's Mini Blog" name=twitter:title><meta content="A Brief guide on how to cross compile a python embedded C program onto a linux based embedded device." name=description><meta content="A Brief guide on how to cross compile a python embedded C program onto a linux based embedded device." property=og:description><meta content="A Brief guide on how to cross compile a python embedded C program onto a linux based embedded device." name=twitter:description><meta content="Jiacheng's Mini Blog" property=og:site_name><meta content=https://jason0214.github.io property=og:url><link crossorigin href=https://fonts.gstatic.com rel=preconnect><link href=https://jason0214.github.io/base.css rel=stylesheet><link href=https://fonts.googleapis.com rel=preconnect><link crossorigin href=https://fonts.gstatic.com rel=preconnect><link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel=stylesheet><link href=https://jason0214.github.io/fontawesome/fontawesome.css rel=stylesheet><link href=https://jason0214.github.io/fontawesome/brands.css rel=stylesheet><link href=https://jason0214.github.io/fontawesome/solid.css rel=stylesheet><link href=https://jason0214.github.io/favicon.ico rel=icon type=image/x-icon><body><a class="skip-link p-screen-reader-text" href=#main>Skip to content</a><header class=l-header><h1 class="c-title p-title"><a class=p-title__link href=https://jason0214.github.io>Jiacheng's Mini Blog</a></h1><p class=p-subtitle>Less tech, more life</header><main class=l-main id=main><article class=p-article><header><h1>Cross Compile Embedded Python</h1><div><div class=c-time><time datetime=" 2018-06-23"> 2018-06-23 </time> - (3 min read)</div></div></header><section class=p-article__body id=js-article><p>A Brief guide on how to cross compile a python embedded C program onto a linux based embedded device.</p><span id=continue-reading></span><h2 id=save-effort-by-using-python-library>Save effort by using python library<a aria-label="Anchor link for: save-effort-by-using-python-library" class=zola-anchor href=#save-effort-by-using-python-library><i class="fas fa-link"></i></a></h2><p>Python is somewhat a glue language, it can be easily embedded to almost all the popular languages. (<em><strong>here 'embedded' means calling python runtime inside other languages</strong></em>)<p>Making use of python can save a lot of effort. Here I want to take advantage of python's http lib to handle complex web requests in my C application.<h2 id=use-python-on-embedded-devices>Use python on embedded devices<a aria-label="Anchor link for: use-python-on-embedded-devices" class=zola-anchor href=#use-python-on-embedded-devices><i class="fas fa-link"></i></a></h2><p>Not every embedded device can easily run python. While there are some powerfully and popular embedded devices, <strong>Raspberry Pi</strong> and <strong>Beagle Bone</strong> , which are able to run an entire linux system. It is fairly straightforward to run python on those devices.<h2 id=cross-compile-python-embedded-c-program-on-beagle-bone-green>Cross compile python embedded C program on Beagle Bone Green<a aria-label="Anchor link for: cross-compile-python-embedded-c-program-on-beagle-bone-green" class=zola-anchor href=#cross-compile-python-embedded-c-program-on-beagle-bone-green><i class="fas fa-link"></i></a></h2><p>Here I use an example of Beagle Bone Green which has an ARM architecture and official Debian operating system support.<p>When cross compiling on host, python libraries and headers on your device need to be accessible. Here are some useful tools that can help to locate the libraries:<ul><li><a href=https://linux.die.net/man/1/pkg-config>pkg-config</a>: run <code>pkg-config --libs --cflags  python3</code> to find all the header files.<li><a href=http://man7.org/linux/man-pages/man1/ldd.1.html>ldd</a>: run <code>ldd /usr/bin/python3.4</code> to find static and shared libs.<li><a href=https://linux.die.net/man/1/readelf>readelf</a> print out symbols in a .so file.</ul><p>Use my BBG device as an example:<ul><li>python header files are located <code>/usr/include/python3.4m/*</code> and <code>/usr/include/arm-linux-gnueabihf/python3.4m/</code><li>python libs are at <code>/usr/lib/python3.4/config-3.4m-arm-linux-gnueabihf/libpython3.4*</code>, <code>/lib/arm-linux-gnueabihf/libz.so.1</code> and <code>/lib/arm-linux-gnueabihf/libexpat.so.1</code>.</ul><p>I used an NFS directory to share the libs and headers to host. (following commands assume it set up at <code>/mnt/remote/</code>)<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>cp -r</span><span> /usr/include/python3.4m/* /mnt/remote/python3.4/include
</span><span style=color:#bf616a>mkdir</span><span> /mnt/remote/python3.4/include/arm-linux-gnueabihf/
</span><span style=color:#bf616a>cp -r</span><span> /usr/include/arm-linux-gnueabihf/python3.4m /mnt/remote/python3.4/include/arm-linux-gnueabihf/
</span><span>
</span><span style=color:#bf616a>cp</span><span> /usr/lib/python3.4/config-3.4m-arm-linux-gnueabihf/libpython3.4* /mnt/remote/python3.4/lib/
</span><span style=color:#bf616a>cp</span><span> /lib/arm-linux-gnueabihf/libz.so.1  /mnt/remote/python3.4/lib/libz.so
</span><span style=color:#bf616a>cp</span><span> /lib/arm-linux-gnueabihf/libexpat.so.1  /mnt/remote/python3.4/lib/libexpat.so
</span></code></pre><p>Set compiler flags:<pre class=language-Makefile data-lang=Makefile style=color:#c0c5ce;background-color:#2b303b><code class=language-Makefile data-lang=Makefile><span>...
</span><span style=color:#65737e># ~/foo/public is the NFS entry on the host
</span><span style=color:#bf616a>IFLAGS</span><span>=</span><span style=color:#a3be8c>-I</span><span style=color:#b48ead>$(</span><span style=color:#bf616a>HOME</span><span style=color:#b48ead>)</span><span style=color:#a3be8c>/foo/public/python3.4/include
</span><span style=color:#bf616a>LFLAGS</span><span>=</span><span style=color:#a3be8c>-L</span><span style=color:#b48ead>$(</span><span style=color:#bf616a>HOME</span><span style=color:#b48ead>)</span><span style=color:#a3be8c>/foo/public/python3.4/lib
</span><span>...
</span></code></pre><h2 id=use-pip-packages>Use pip packages<a aria-label="Anchor link for: use-pip-packages" class=zola-anchor href=#use-pip-packages><i class="fas fa-link"></i></a></h2><p>Note that embedded python interpret does not load pip package path by default. You need to call <code>PySys_SetPath()</code> to manually setup the paths of the python modules you want to access.<pre class=language-c data-lang=c style=color:#c0c5ce;background-color:#2b303b><code class=language-c data-lang=c><span style=color:#b48ead>#define  </span><span>PY_PACKAGE_PATH </span><span style=color:#b48ead>L</span><span>"</span><span style=color:#a3be8c>/usr/local/lib/python3.4/dist-packages</span><span>"
</span><span>
</span><span>wchar_t* wc_default_path = </span><span style=color:#bf616a>Py_GetPath</span><span>();
</span><span>size_t full_path_len = </span><span style=color:#96b5b4>wcslen</span><span>(wc_default_path) + </span><span style=color:#d08770>1 </span><span>+ </span><span style=color:#96b5b4>wcslen</span><span>(PY_PACKAGE_PATH) + </span><span style=color:#d08770>1</span><span>;
</span><span>wchar_t* wc_whole_path = (wchar_t*)</span><span style=color:#96b5b4>malloc</span><span>(sizeof(wchar_t) * full_path_len);
</span><span style=color:#bf616a>wcscpy</span><span>(wc_whole_path, wc_default_path);
</span><span style=color:#bf616a>wcscat</span><span>(wc_whole_path, </span><span style=color:#b48ead>L</span><span>"</span><span style=color:#a3be8c>:</span><span>");
</span><span style=color:#bf616a>wcscat</span><span>(wc_whole_path, PY_PACKAGE_PATH);
</span><span>
</span><span style=color:#bf616a>PySys_SetPath</span><span>(wc_whole_path)
</span></code></pre><h2 id=be-aware-of-gil>Be Aware of GIL<a aria-label="Anchor link for: be-aware-of-gil" class=zola-anchor href=#be-aware-of-gil><i class="fas fa-link"></i></a></h2><p>Most of the python implementation has a GIL, which can be quite annoying when you are using multi-threads. Here is a <a href=https://stackoverflow.com/questions/15470367/pyeval-initthreads-in-python-3-how-when-to-call-it-the-saga-continues-ad-naus/15471525#15471525>thread</a> that may help.<h2 id=reference>Reference<a aria-label="Anchor link for: reference" class=zola-anchor href=#reference><i class="fas fa-link"></i></a></h2><ul><li><a href=https://stackoverflow.com/questions/48703423/cython-compile-a-standalone-static-executable>https://stackoverflow.com/questions/48703423/cython-compile-a-standalone-static-executable</a><li><a href=https://stackoverflow.com/questions/34732/how-do-i-list-the-symbols-in-a-so-file>https://stackoverflow.com/questions/34732/how-do-i-list-the-symbols-in-a-so-file</a><li><a href=https://stackoverflow.com/questions/15470367/pyeval-initthreads-in-python-3-how-when-to-call-it-the-saga-continues-ad-naus/15471525#15471525>https://stackoverflow.com/questions/15470367/pyeval-initthreads-in-python-3-how-when-to-call-it-the-saga-continues-ad-naus/15471525#15471525</a></ul></section><footer><nav class="c-pagination p-pagination"><div class=c-pagination__ctrl><div class=c-pagination__newer></div><div class=c-pagination__older></div></div></nav></footer></article></main><footer class=l-footer><p class=p-copyright></footer>
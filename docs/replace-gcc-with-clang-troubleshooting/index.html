<!doctype html><html lang=en><head><meta charset=utf-8><meta content=no-referrer name=referrer><meta content="width=device-width,initial-scale=1.0,maximum-scale=5" name=viewport><title>Replace gcc with clang Troubleshooting | Jiacheng's Mini Blog</title><meta content="Replace gcc with clang Troubleshooting | Jiacheng's Mini Blog" property=og:title><meta content="Replace gcc with clang Troubleshooting | Jiacheng's Mini Blog" name=twitter:title><meta content="I was rebuilding Interval-Based-Reclamation with clang to adapt it to a microbenchmark for garbage collection with coroutine (clang has a better coroutine implementation). I made several mistakes which took me a long time to figure out. The mistakes are silly, while the investigation is kinda fun and worth sharing." name=description><meta content="I was rebuilding Interval-Based-Reclamation with clang to adapt it to a microbenchmark for garbage collection with coroutine (clang has a better coroutine implementation). I made several mistakes which took me a long time to figure out. The mistakes are silly, while the investigation is kinda fun and worth sharing." property=og:description><meta content="I was rebuilding Interval-Based-Reclamation with clang to adapt it to a microbenchmark for garbage collection with coroutine (clang has a better coroutine implementation). I made several mistakes whicâ€¦" name=twitter:description><meta content="Jiacheng's Mini Blog" property=og:site_name><meta content=https://jason0214.github.io property=og:url><link crossorigin href=https://fonts.gstatic.com rel=preconnect><link href=https://jason0214.github.io/base.css rel=stylesheet><link href=https://fonts.googleapis.com rel=preconnect><link crossorigin href=https://fonts.gstatic.com rel=preconnect><link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel=stylesheet><link href=https://jason0214.github.io/fontawesome/fontawesome.css rel=stylesheet><link href=https://jason0214.github.io/fontawesome/brands.css rel=stylesheet><link href=https://jason0214.github.io/fontawesome/solid.css rel=stylesheet><link href=https://jason0214.github.io/favicon.ico rel=icon type=image/x-icon><body><a class="skip-link p-screen-reader-text" href=#main>Skip to content</a><header class=l-header><h1 class="c-title p-title"><a class=p-title__link href=https://jason0214.github.io>Jiacheng's Mini Blog</a></h1><p class=p-subtitle>Less tech, more life</header><main class=l-main id=main><article class=p-article><header><h1>Replace gcc with clang Troubleshooting</h1><div><div class=c-time><time datetime=" 2020-06-20"> 2020-06-20 </time> - (3 min read)</div></div></header><section class=p-article__body id=js-article><p>I was rebuilding <a href=https://github.com/roghnin/Interval-Based-Reclamation>Interval-Based-Reclamation</a> with <code>clang</code> to adapt it to a microbenchmark for garbage collection with coroutine (<code>clang</code> has a better coroutine implementation). I made several mistakes which took me a long time to figure out. The mistakes are silly, while the investigation is kinda fun and worth sharing.</p><span id=continue-reading></span><h2 id=set-libc-in-linker-flags>Set libc++ in linker flags<a aria-label="Anchor link for: set-libc-in-linker-flags" class=zola-anchor href=#set-libc-in-linker-flags><i class="fas fa-link"></i></a></h2><p>The first mistake I made is that I forget to put <code>-stdlib=libc++</code> in <code>LD_FLAGS</code>. Therefore I got a bunch of undefined reference error:<pre style=color:#c0c5ce;background-color:#2b303b><code><span>/usr/bin/../lib64/gcc/x86_64-pc-linux-gnu/10.1.0/../../../../include/c++/10.1.0/bits/basic_string.tcc:219: undefined reference to `std::__cxx11::basic_string&lt;char, std::char_traits&lt;char>, std::allocator&lt;char> >::_M_create(unsigned long&, unsigned long)'
</span><span>/usr/bin/ld: ./ext/parharness/libparharness.a(Recorder.o): in function `void std::__cxx11::list&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char>, std::allocator&lt;char> >, std::allocator&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char>, std::allocator&lt;char> > > >::_M_insert&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char>, std::allocator&lt;char> > const&>(std::_List_iterator&lt;std::__cxx11::basic_string&lt;char, std::char_traits&lt;char>, std::allocator&lt;char> > >, std::__cxx11::basic_string&lt;char, std::char_traits&lt;char>, std::allocator&lt;char> > const&)':
</span><span>...
</span></code></pre><p><a href=https://github.com/roghnin/Interval-Based-Reclamation/blob/master/Makefile>Interval-Based-Reclamation</a> uses Makefile. It separates the compiler flags for source compiling and object linking into <code>CXX_FLAGS</code> and <code>LD_FLAGS</code> respectively, which I failed to notice in the first place. You will need <code>-stdlib=libc++</code> in <code>CXX_FLAGS</code> to find headers and in <code>LD_FLAGS</code> to find the shared libraries.<p>Actually there is no error information when you link an object using the <code>clang</code> command. I realize the mistake I made only when I turn on compiler verbose mode.<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>$</span><span> make CXX="</span><span style=color:#a3be8c>clang++ -v</span><span>" </span><span style=color:#d08770>2</span><span>>&</span><span style=color:#d08770>1 </span><span>| </span><span style=color:#bf616a>grep</span><span> stdc++
</span></code></pre><p>I got the log where I saw <code>-lstdc++</code> in the output of <code>ld</code> call made by <code>clang</code><pre style=color:#c0c5ce;background-color:#2b303b><code><span> "/usr/bin/ld" -pie --eh-frame-hdr -m elf_x86_64 -dynamic-linker /lib64/ld-linux-x86-64.so.2 -o bin/release/main /usr/bin/../lib64/gcc/x86_64-pc-linux-gnu/10.1.0/../../../../lib64/Scrt1.o /usr/bin/../lib64/gcc/x86_64-pc-linux-gnu/10.1.0/crti.o /usr/bin/../lib64/gcc/x86_64-pc-linux-gnu/10.1.0/crtbeginS.o -L./ext/parharness -L/usr/bin/../lib64/gcc/x86_64-pc-linux-gnu/10.1.0 -L/usr/bin/../lib64/gcc/x86_64-pc-linux-gnu/10.1.0/../../../../lib64 -L/usr/bin/../lib64 -L/lib/../lib64 -L/usr/lib/../lib64 -L/usr/bin/../lib64/gcc/x86_64-pc-linux-gnu/10.1.0/../../.. -L/usr/bin/../lib -L/lib -L/usr/lib obj/release/src/CustomTests.o obj/release/src/rideables/BonsaiTreeRange.o obj/release/src/rideables/BonsaiTree.o obj/release/src/coroutine.o obj/release/src/main.o -lparharness -lhwloc -lpthread -lm -lrt -lstdc++ -lm -lgcc_s -lgcc -lc -lgcc_s -lgcc /usr/bin/../lib64/gcc/x86_64-pc-linux-gnu/10.1.0/crtendS.o /usr/bin/../lib64/gcc/x86_64-pc-linux-gnu/10.1.0/../../../../lib64/crtn.o
</span></code></pre><h2 id=verify-libc-is-visible-to-linker>Verify libc++ is visible to linker<a aria-label="Anchor link for: verify-libc-is-visible-to-linker" class=zola-anchor href=#verify-libc-is-visible-to-linker><i class="fas fa-link"></i></a></h2><p>After the fix of putting <code>-stdlib=libc++</code> to link flags, the linking issue persists. Therefore, I made further checkups to veiryf libc++ is correctly installed.<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>$</span><span> ldconfig</span><span style=color:#bf616a> -p </span><span>| </span><span style=color:#bf616a>grep</span><span> libc++
</span></code></pre><p>got<pre style=color:#c0c5ce;background-color:#2b303b><code><span>	libc++abi.so.1 (libc6,x86-64) => /usr/lib/libc++abi.so.1
</span><span>	libc++abi.so (libc6,x86-64) => /usr/lib/libc++abi.so
</span><span>	libc++.so.1 (libc6,x86-64) => /usr/lib/libc++.so.1
</span></code></pre><p>which is fine.<h2 id=manually-link-libc-abi-on-arch>Manually link libc++abi on Arch<a aria-label="Anchor link for: manually-link-libc-abi-on-arch" class=zola-anchor href=#manually-link-libc-abi-on-arch><i class="fas fa-link"></i></a></h2><p>Lot of threads on the web report linking issues building some C++ libraries on Arch Linux because of missing <code>libc++abi</code>. For example, https://github.com/google/filament/issues/16.<p>In my case, the missing symbols seem to come from <code>libc++</code> (e.g. std::basic_string), not from <code>libc++abi</code>. Anyway I tried put<pre class=language-Makefile data-lang=Makefile style=color:#c0c5ce;background-color:#2b303b><code class=language-Makefile data-lang=Makefile><span style=color:#bf616a>LD_FLAGS </span><span>+= </span><span style=color:#a3be8c>-lc++abi
</span></code></pre><p>in linking, it does not solve the issue as expected.<h2 id=use-lld-to-link-shared-libraries>Use lld to link shared libraries<a aria-label="Anchor link for: use-lld-to-link-shared-libraries" class=zola-anchor href=#use-lld-to-link-shared-libraries><i class="fas fa-link"></i></a></h2><p>I suspect that the GNU <code>ld</code> may have some issues in finding <code>libc++</code>, so I switched to LLVM <code>lld</code>. Setup linking flags following <a href=https://lld.llvm.org/#using-lld>using-lld</a><pre class=language-Makefile data-lang=Makefile style=color:#c0c5ce;background-color:#2b303b><code class=language-Makefile data-lang=Makefile><span style=color:#bf616a>LD_FLAGS </span><span>+= </span><span style=color:#a3be8c>-fuse-ld=lld
</span></code></pre><p><code>lld</code> works surprisingly well. It noticeably increases linking speed and generates error messages that are far more readable.<pre style=color:#c0c5ce;background-color:#2b303b><code><span>ld.lld: error: undefined symbol: std::__cxx11::basic_string&lt;char, std::char_traits&lt;char>, std::allocator&lt;char> >::_M_assign(std::__cxx11::basic_string&lt;char, std::char_traits&lt;char>, std::allocator&lt;char> > const&)
</span><span>>>> referenced by basic_string.h:1366 (/usr/include/c++/10.1.0/bits/basic_string.h:1366)
</span><span>>>>               TestConfig.o:(GlobalTestConfig::parseCommandLine(int, char**)) in archive ./ext/parharness/libparharness.a
</span><span>>>> referenced by basic_string.h:1366 (/usr/include/c++/10.1.0/bits/basic_string.h:1366)
</span><span>>>>               TestConfig.o:(GlobalTestConfig::parseCommandLine(int, char**)) in archive ./ext/parharness/libparharness.a
</span><span>>>> referenced by basic_string.h:1366 (/usr/include/c++/10.1.0/bits/basic_string.h:1366)
</span><span>>>>               TestConfig.o:(GlobalTestConfig::setEnv(std::__cxx11::basic_string&lt;char, std::char_traits&lt;char>, std::allocator&lt;char> >, std::__cxx11::basic_string&lt;char, std::char_traits&lt;char>, std::allocator&lt;char> >)) in archive ./ext/parharness/libparharness.a
</span><span>>>> referenced by basic_string.h:1366 (/usr/include/c++/10.1.0/bits/basic_string.h:1366)
</span><span>>>>               Recorder.o:(Recorder::reportThreadInfo(std::__cxx11::basic_string&lt;char, std::char_traits&lt;char>, std::allocator&lt;char> >, std::__cxx11::basic_string&lt;char, std::char_traits&lt;char>, std::allocator&lt;char> >, int)) in archive ./ext/parharness/libparharness.a
</span><span>>>> referenced by basic_string.h:1366 (/usr/include/c++/10.1.0/bits/basic_string.h:1366)
</span><span>>>>               Recorder.o:(Recorder::reportGlobalInfo(std::__cxx11::basic_string&lt;char, std::char_traits&lt;char>, std::allocator&lt;char> >, std::__cxx11::basic_string&lt;char, std::char_traits&lt;char>, std::allocator&lt;char> >)) in archive ./ext/parharness/libparharness.a
</span></code></pre><p>The errors all point to <code>./ext/parharness/libparharness.a</code> which is built from a submodule of <a href=https://github.com/roghnin/Interval-Based-Reclamation/tree/master/ext/parharness>Interval-Based-Reclamation</a>.<h2 id=check-symbols-in-objects>Check symbols in objects<a aria-label="Anchor link for: check-symbols-in-objects" class=zola-anchor href=#check-symbols-in-objects><i class="fas fa-link"></i></a></h2><p>I further checks the symbols in each <code>.o</code> objects that are archived to <code>libparharness.a</code>. I realize that <code>nm</code> is quite handy to check symbols, easier to use than <code>objdump</code>. Specify <code>-g</code> to only display external symbols and <code>-C</code> to display a human readable symbol name.<p>In <code>TestConfig.o</code>, an object from <code>libparharness.a</code>.<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>$</span><span> nm</span><span style=color:#bf616a> -gC</span><span> TestConfig.o  | </span><span style=color:#bf616a>grep</span><span> getEnv
</span></code></pre><p>got<pre style=color:#c0c5ce;background-color:#2b303b><code><span>0000000000002d30 T GlobalTestConfig::getEnv(std::__cxx11::basic_string&lt;char, std::char_traits&lt;char>, std::allocator&lt;char> >)
</span></code></pre><p>In <code>main.o</code><pre style=color:#c0c5ce;background-color:#2b303b><code><span>$ nm -gC main.o | grep getEnv
</span></code></pre><p>got<pre style=color:#c0c5ce;background-color:#2b303b><code><span>                 U GlobalTestConfig::getEnv(std::__1::basic_string&lt;char,std::__1::char_traits&lt;char>, std::__1::allocator&lt;char> >)
</span></code></pre><p>a namespace mismatch between <code>std::__1::</code> and <code>std::__cxx11</code>. <code>std::__1::</code> is the default namespace for <code>libc++</code> with C++11 plus. While <code>std::__cxx11</code> is the default namespace for <code>stdlibc++</code>.<p>I finally noticed that I made a typo in toggling <code>libc++</code> in <code>libparharness.a</code> where I put <code>-std=libc++</code> instead of <code>-stdlib=libc++</code>.<h2 id=reference>Reference<a aria-label="Anchor link for: reference" class=zola-anchor href=#reference><i class="fas fa-link"></i></a></h2><ul><li><a href=https://stackoverflow.com/questions/38441490/how-to-check-if-libc-is-installed>https://stackoverflow.com/questions/38441490/how-to-check-if-libc-is-installed</a><li><a href=https://stackoverflow.com/questions/3880924/how-to-view-symbols-in-object-files>https://stackoverflow.com/questions/3880924/how-to-view-symbols-in-object-files</a><li><a href=https://stackoverflow.com/questions/29293394/where-does-the-1-symbol-come-from-when-using-llvms-libc>https://stackoverflow.com/questions/29293394/where-does-the-1-symbol-come-from-when-using-llvms-libc</a></ul></section><footer><nav class="c-pagination p-pagination"><div class=c-pagination__ctrl><div class=c-pagination__newer></div><div class=c-pagination__older></div></div></nav></footer></article></main><footer class=l-footer><p class=p-copyright></footer>
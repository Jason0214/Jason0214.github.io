<!doctype html><html lang=en><head><meta charset=utf-8><meta content=no-referrer name=referrer><meta content="width=device-width,initial-scale=1.0,maximum-scale=5" name=viewport><title>Set Up Wireguard VPN Server | Jiacheng's Mini Blog</title><meta content="Set Up Wireguard VPN Server | Jiacheng's Mini Blog" property=og:title><meta content="Set Up Wireguard VPN Server | Jiacheng's Mini Blog" name=twitter:title><meta content="Wireguard is a VPN protocol, which has an implementation presents in the Linux kernel. This post records my first time experience setting up a Wireguard VPN for my heterogeneous devices (Macbook, iphone, etc.)" name=description><meta content="Wireguard is a VPN protocol, which has an implementation presents in the Linux kernel. This post records my first time experience setting up a Wireguard VPN for my heterogeneous devices (Macbook, iphone, etc.)" property=og:description><meta content="Wireguard is a VPN protocol, which has an implementation presents in the Linux kernel. This post records my first time experience setting up a Wireguard VPN for my heterogeneous devices (Macbook, iphoâ€¦" name=twitter:description><meta content="Jiacheng's Mini Blog" property=og:site_name><meta content=https://jason0214.github.io property=og:url><link crossorigin href=https://fonts.gstatic.com rel=preconnect><link href=https://jason0214.github.io/base.css rel=stylesheet><link href=https://fonts.googleapis.com rel=preconnect><link crossorigin href=https://fonts.gstatic.com rel=preconnect><link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel=stylesheet><link href=https://jason0214.github.io/fontawesome/fontawesome.css rel=stylesheet><link href=https://jason0214.github.io/fontawesome/brands.css rel=stylesheet><link href=https://jason0214.github.io/fontawesome/solid.css rel=stylesheet><link href=https://jason0214.github.io/favicon.ico rel=icon type=image/x-icon><body><a class="skip-link p-screen-reader-text" href=#main>Skip to content</a><header class=l-header><h1 class="c-title p-title"><a class=p-title__link href=https://jason0214.github.io>Jiacheng's Mini Blog</a></h1><p class=p-subtitle>Less tech, more life</header><main class=l-main id=main><article class=p-article><header><h1>Set Up Wireguard VPN Server</h1><div><div class=c-time><time datetime=" 2022-02-13"> 2022-02-13 </time> - (5 min read)</div></div></header><section class=p-article__body id=js-article><p>Wireguard is a VPN protocol, which has an implementation presents in the Linux kernel. This post records my first time experience setting up a Wireguard VPN for my heterogeneous devices (Macbook, iphone, etc.)</p><span id=continue-reading></span><h3 id=motivation>Motivation<a aria-label="Anchor link for: motivation" class=zola-anchor href=#motivation><i class="fas fa-link"></i></a></h3><p>There are a lot of things of Wireguard that I would consider very interesting. Such as<ul><li><a href=https://www.wireguard.com/formal-verification/>formal verification</a> that the protocol that has gone through,<li><a href=https://git.zx2c4.com/wireguard-linux>implementation</a> inside Linux kernel,<li><a href=https://github.com/WireGuard>clients</a> are available for different platforms with community efforts, etc.</ul><p>These facts give me a good confidence on its security and performance. And here goes this post, a written down of my first time experience to set up a working Wireguard VPN service.<h3 id=the-server>The server<a aria-label="Anchor link for: the-server" class=zola-anchor href=#the-server><i class="fas fa-link"></i></a></h3><p>I used a VM instance from one of those big cloud service providers to build my Wireguard server. I call it a server because I have some presets in my mind about how I would use the Wireguard guard for, I would like to re-route all the network traffic of some of my mobile devices to a remote server. Thus, the remote server works more like a "server".<p>However, the Wireguard protocol and its configuration are more Peer-to-Peer-ish. It can be more flexible than the server-client model I am going to describe below.<p>I used a Ubuntu 20.04 LTS for my server. Wireguard implementation is presented in Linux kernel starting from 5.6. If you are using a kernel older than 5.6, you need to install the manually install Wireguard kernel driver through "apt install wireguard-dkms", otherwise you are good. In both case, you will need some userspace utilities through "apt install wireguard".<h4 id=key-pairs>Key pairs<a aria-label="Anchor link for: key-pairs" class=zola-anchor href=#key-pairs><i class="fas fa-link"></i></a></h4><p>Wireguard peers authenticates use public and private key. Every Wireguard peer (either server or client in my case) generates a public and private key pair. The public key will be given to other peers for authentication and access control. <a href=https://www.digitalocean.com/community/tutorials/how-to-set-up-wireguard-on-ubuntu-20-04#step-1-installing-wireguard-and-generating-a-key-pair>This DigitalOcean guide</a> gives a good instruction on to generate key pairs.<h4 id=choose-ip-ranges>Choose IP ranges<a aria-label="Anchor link for: choose-ip-ranges" class=zola-anchor href=#choose-ip-ranges><i class="fas fa-link"></i></a></h4><p>The above DO Wireguard guide also has a well written section on how to choose both IPv4 and IPv6 for VPNs.<p>In my case, I choose the subnet 10.8.0.1/24.<h4 id=create-ip-interface-and-routes>Create ip interface and routes<a aria-label="Anchor link for: create-ip-interface-and-routes" class=zola-anchor href=#create-ip-interface-and-routes><i class="fas fa-link"></i></a></h4><pre style=color:#c0c5ce;background-color:#2b303b><code><span>ip link add dev wg0 type wireguard
</span></code></pre><p>This command creates an interface "wg0" with type <code>wireguard</code>.<pre style=color:#c0c5ce;background-color:#2b303b><code><span>ip address add dev wg0 10.8.0.1/24
</span></code></pre><p>This command assigns IP protocol and address to the interface "wg0". It is essential for the server to know that it needs to send traffic with destination "10.8.0.1/24" to interface "wg0". You can use <code>ip route</code> to verify its effect.<pre style=color:#c0c5ce;background-color:#2b303b><code><span>ip link set up dev wg0
</span></code></pre><p>Activate the "wg0" interface. Now, you can see it with <code>ifconfig</code><h4 id=create-configuration>Create configuration<a aria-label="Anchor link for: create-configuration" class=zola-anchor href=#create-configuration><i class="fas fa-link"></i></a></h4><p>Edit "/etc/wireguard/wg0.conf" to the following content<pre class=language-nginx data-lang=nginx style=color:#c0c5ce;background-color:#2b303b><code class=language-nginx data-lang=nginx><span>[Interface]
</span><span>ListenPort = ... 
</span><span>PrivateKey = ... 
</span><span>
</span><span>[Peer]
</span><span>PublicKey = ... # The public key of peer(client)
</span><span>AllowedIPs = 10.8.0.2 # I will assign this IP to client in the following sections.
</span><span>
</span><span>#[Peer]
</span><span># More peers ...
</span></code></pre><p>Most of the fields here are trivial to fill. However, the "AllowedIPs" is worth some explanation. This fields denotes what traffic the server is going to send to the client. Since I am building a server-client model, the server only needs send client the traffic aiming for the client, thus the field is the client's IP. If you are setting up a topology that allows some kind of broadcast within the subnet, then "10.8.0.0/24" would make more sense.<p>Also, note that "ListenPort" is the used by the kernel implementation to watch for UDP traffic. Not TCP it is using, and not from a user space process, so don't expect to find the port being opened on those monitoring tool. Though, you will see ingress and egress traffic on the port when the VPN is on later.<pre style=color:#c0c5ce;background-color:#2b303b><code><span>wg setconf wg0 /etc/wireguard/wg0.conf
</span></code></pre><p>This command applies the above configurations to "wg0" interface. You can use "wg show" to<h4 id=firewall-rules>Firewall rules<a aria-label="Anchor link for: firewall-rules" class=zola-anchor href=#firewall-rules><i class="fas fa-link"></i></a></h4><pre style=color:#c0c5ce;background-color:#2b303b><code><span>iptables -A FORWARD -i wg0 -o &lt;ethernet_interface> -j ACCEPT
</span><span>iptables -t nat -I POSTROUTING -o &lt;ethernet_interface> -j MASQUERADE
</span></code></pre><p>These two rules forwards traffics from interface "wg0" to the actual ethernet interface. Refer to <a href=https://www.digitalocean.com/community/tutorials/how-to-set-up-wireguard-on-ubuntu-20-04#step-5-configuring-the-wireguard-server-s-firewall>DO Wireguard guide</a> on the explanation and how to get the ethernet interface.<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>apt</span><span> install iptables-persistent
</span></code></pre><p>To make those rules persistent to reboot.<h4 id=setup-systemctl-service>Setup systemctl service<a aria-label="Anchor link for: setup-systemctl-service" class=zola-anchor href=#setup-systemctl-service><i class="fas fa-link"></i></a></h4><p>The userspace Wireguard tool comes with a nice script <code>wg-quick</code> and a service <code>/lib/systemd/system/wg-quick@.service</code>. With the help of them, the above created "wg0.conf" can be easily turned into a systemctl service.<p>Before creating the service for "wg0", we would want to de-active what we have done to it. Otherwise, when service starts, some ip settings may duplicate and fail.<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>wg-quick</span><span> down wg0 </span><span style=color:#65737e># The reverse is "wg-quick up wg0"
</span></code></pre><pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>systemctl</span><span> enable wg-quick@wg0 </span><span style=color:#65737e># maps to /etc/wireguard/wg0.conf
</span><span style=color:#bf616a>systemctl</span><span> start wg-quick@wg0
</span></code></pre><h3 id=the-client>The client<a aria-label="Anchor link for: the-client" class=zola-anchor href=#the-client><i class="fas fa-link"></i></a></h3><p>Setup client is very similar to dealing with the server. Anyway from the perspective of the protocol, both of them are just Wireguard peers.<p>I used the Wireguard client from Apple App Store. It turns out that I only need to provide a configuration file, other parts are taken care of by the application itself.<p>The client configuration looks like this:<pre class=language-nginx data-lang=nginx style=color:#c0c5ce;background-color:#2b303b><code class=language-nginx data-lang=nginx><span>[Interface]
</span><span>PrivateKey = ...
</span><span>Address = 10.8.0.2/24
</span><span>DNS = 8.8.8.8
</span><span>
</span><span>[Peer]
</span><span>PublicKey = ...
</span><span>AllowedIPs = 0.0.0.0/0
</span><span>Endpoint = &lt;server_ip>:&lt;server_listen_port>
</span><span>PersistentKeepalive = 25
</span></code></pre><p>Simply provides "DNS" in the "interface" would allow all the DNS traffic to go through the VPN. For the "AllowedIPS" field, I fill it with wild card because I want to secure all the traffic. Also some are saying "PersistentKeepalive" is important if your peers are behind stateful firewall.<h3 id=debugging>Debugging<a aria-label="Anchor link for: debugging" class=zola-anchor href=#debugging><i class="fas fa-link"></i></a></h3><p>Because the Wireguard implementation resides in the Linux kernel, it almost leaves no trace in the user space. The only approach let Wireguard spit out some logs is through the kernel dynamic debugging.<pre style=color:#c0c5ce;background-color:#2b303b><code><span>echo module wireguard +p > /sys/kernel/debug/dynamic_debug/control
</span></code></pre><p>However, on my VM, I found privilege is missing even I execute the command from "root" user, which means the <code>debugfs</code> is not accessible at all. So, do expect this to happen, if you are also running VMs from service providers. Fortunately, compared to other alternative technologies, I found Wireguard relatively easier to set up.<p>Thanks for the reading.<h2 id=reference>Reference<a aria-label="Anchor link for: reference" class=zola-anchor href=#reference><i class="fas fa-link"></i></a></h2><ul><li><a href=https://www.digitalocean.com/community/tutorials/how-to-set-up-wireguard-on-ubuntu-20-04>https://www.digitalocean.com/community/tutorials/how-to-set-up-wireguard-on-ubuntu-20-04</a><li><a href=https://www.wireguard.com/quickstart/>https://www.wireguard.com/quickstart/</a></ul></section><footer><nav class="c-pagination p-pagination"><div class=c-pagination__ctrl><div class=c-pagination__newer></div><div class=c-pagination__older></div></div></nav></footer></article></main><footer class=l-footer><p class=p-copyright></footer>
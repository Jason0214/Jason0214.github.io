<!doctype html><html lang=en><head><meta charset=utf-8><meta content=no-referrer name=referrer><meta content="width=device-width,initial-scale=1.0,maximum-scale=5" name=viewport><title>Better Proxy with NAT Transfer | Jiacheng's Mini Blog</title><meta content="Better Proxy with NAT Transfer | Jiacheng's Mini Blog" property=og:title><meta content="Better Proxy with NAT Transfer | Jiacheng's Mini Blog" name=twitter:title><meta content="I have a proxy server that works well, but recently I was quite suffering from the bad networking (very high latency and packet loss) accessing my server. I have managed to setup another closeby server to do a NAT transfer, which (at least partially) solved the issue." name=description><meta content="I have a proxy server that works well, but recently I was quite suffering from the bad networking (very high latency and packet loss) accessing my server. I have managed to setup another closeby server to do a NAT transfer, which (at least partially) solved the issue." property=og:description><meta content="I have a proxy server that works well, but recently I was quite suffering from the bad networking (very high latency and packet loss) accessing my server. I have managed to setup another closeby serveâ€¦" name=twitter:description><meta content="Jiacheng's Mini Blog" property=og:site_name><meta content=https://jason0214.github.io property=og:url><link crossorigin href=https://fonts.gstatic.com rel=preconnect><link href=https://jason0214.github.io/base.css rel=stylesheet><link href=https://fonts.googleapis.com rel=preconnect><link crossorigin href=https://fonts.gstatic.com rel=preconnect><link href="https://fonts.googleapis.com/css2?family=Atkinson+Hyperlegible:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel=stylesheet><link href=https://jason0214.github.io/fontawesome/fontawesome.css rel=stylesheet><link href=https://jason0214.github.io/fontawesome/brands.css rel=stylesheet><link href=https://jason0214.github.io/fontawesome/solid.css rel=stylesheet><link href=https://jason0214.github.io/favicon.ico rel=icon type=image/x-icon><body><a class="skip-link p-screen-reader-text" href=#main>Skip to content</a><header class=l-header><h1 class="c-title p-title"><a class=p-title__link href=https://jason0214.github.io>Jiacheng's Mini Blog</a></h1><p class=p-subtitle>Less tech, more life</header><main class=l-main id=main><article class=p-article><header><h1>Better Proxy with NAT Transfer</h1><div><div class=c-time><time datetime=" 2020-05-27"> 2020-05-27 </time> - (2 min read)</div></div></header><section class=p-article__body id=js-article><p>I have a proxy server that works well, but recently I was quite suffering from the bad networking (very high latency and packet loss) accessing my server.<p>I have managed to setup another closeby server to do a NAT transfer, which (at least partially) solved the issue.</p><span id=continue-reading></span><h2 id=nat-through-iptables>NAT through iptables<a aria-label="Anchor link for: nat-through-iptables" class=zola-anchor href=#nat-through-iptables><i class="fas fa-link"></i></a></h2><p><code>iptables</code> is quite handy to use to setup a NAT. Set up a TCP NAT only takes two rules, while a UDP one may be more complex. Here is a TCP example:<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>sudo</span><span> iptables</span><span style=color:#bf616a> -t</span><span> nat</span><span style=color:#bf616a> -A</span><span> PREROUTING</span><span style=color:#bf616a> -p</span><span> tcp</span><span style=color:#bf616a> --dport </span><span>$</span><span style=color:#bf616a>DST_SERVER_PORT -j</span><span> DNAT</span><span style=color:#bf616a> --to-destination </span><span>$</span><span style=color:#bf616a>DST_SERVER_IP</span><span>:$</span><span style=color:#bf616a>DST_SERVER_PORT
</span><span style=color:#bf616a>sudo</span><span> iptables</span><span style=color:#bf616a> -t</span><span> nat</span><span style=color:#bf616a> -A</span><span> POSTROUTING</span><span style=color:#bf616a> -p</span><span> tcp</span><span style=color:#bf616a> -d </span><span>$</span><span style=color:#bf616a>DST_SERVER_IP --dport </span><span>$</span><span style=color:#bf616a>DST_SERVER_PORT -j</span><span> SNAT</span><span style=color:#bf616a> --to-source </span><span>$</span><span style=color:#bf616a>LOCAL_PRIVATE_IP
</span></code></pre><p>Note that:<ol><li>These two rules do not change the <code>dst port</code>, make sure to set the listening port of the NAT server the same as the destination server.<li>when tampering the source IP of the packets, make it the NAT server's private IP (LOCAL_PRIVATE_IP) instead of the public. It could be very likely that your rented NAT server is also running behind another NAT.</ol><h2 id=verify-nat-works>Verify NAT works<a aria-label="Anchor link for: verify-nat-works" class=zola-anchor href=#verify-nat-works><i class="fas fa-link"></i></a></h2><p>Running <code>tcptrack</code> on your NAT server to check the traffic<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#bf616a>sudo</span><span> tcptrack</span><span style=color:#bf616a> -i</span><span> eth0
</span></code></pre><p>If the setting is good, you will see two ESTABLISHED connections for every incoming TCP connection (exactly a NAT will do).<h2 id=add-firewall-rule-to-allow-only-specific-ips>Add firewall rule to allow only specific IPs<a aria-label="Anchor link for: add-firewall-rule-to-allow-only-specific-ips" class=zola-anchor href=#add-firewall-rule-to-allow-only-specific-ips><i class="fas fa-link"></i></a></h2><p>If you are sure that clients will connect to your NAT server from a static IP or subnet. It would be better configure it to a firewall rule, so that bandwidth can be saved from transferring random packets in the network.<p><img alt=1 src=http://linux-training.be/networking/images/iptables_filter.png><p>Note the firewall for NAT goes to FORWARD instead of INPUT.<pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#65737e># New chain
</span><span style=color:#bf616a>sudo</span><span> iptables</span><span style=color:#bf616a> -N</span><span> NAT_WHITE_LIST
</span><span>
</span><span style=color:#65737e># Accept the proxy server
</span><span style=color:#bf616a>sudo</span><span> iptables</span><span style=color:#bf616a> -A</span><span> NAT_WHITE_LIST</span><span style=color:#bf616a> --source</span><span>=$</span><span style=color:#bf616a>DST_SERVER_IP -j</span><span> RETURN
</span><span style=color:#65737e># Accept known IPs
</span><span style=color:#bf616a>sudo</span><span> iptables</span><span style=color:#bf616a> -A</span><span> NAT_WHITE_LIST</span><span style=color:#bf616a> --source</span><span>=$</span><span style=color:#bf616a>ALLOWED_DOMAINS -j</span><span> RETURN 
</span><span style=color:#65737e># DROP others
</span><span style=color:#bf616a>sudo</span><span> iptables</span><span style=color:#bf616a> -A</span><span> NAT_WHITE_LIST</span><span style=color:#bf616a> -j</span><span> DROP
</span><span>
</span><span style=color:#65737e># Enable chain on FORWARD and NAT port 
</span><span style=color:#bf616a>sudo</span><span> iptables</span><span style=color:#bf616a> -A</span><span> FORWARD</span><span style=color:#bf616a> -j</span><span> NAT_WHITE_LIST
</span></code></pre><h3 id=enable-ip-forward>Enable ip forward<a aria-label="Anchor link for: enable-ip-forward" class=zola-anchor href=#enable-ip-forward><i class="fas fa-link"></i></a></h3><pre class=language-bash data-lang=bash style=color:#c0c5ce;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#96b5b4>echo</span><span> 1 > /proc/sys/net/ipv4/ip_forward
</span></code></pre><h2 id=reference>Reference<a aria-label="Anchor link for: reference" class=zola-anchor href=#reference><i class="fas fa-link"></i></a></h2><ul><li><a href=http://linux-training.be/networking/ch14.html>http://linux-training.be/networking/ch14.html</a></ul></section><footer><nav class="c-pagination p-pagination"><div class=c-pagination__ctrl><div class=c-pagination__newer></div><div class=c-pagination__older></div></div></nav></footer></article></main><footer class=l-footer><p class=p-copyright></footer>